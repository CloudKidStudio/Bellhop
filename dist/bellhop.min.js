!function(){var t=function(){this._listeners={}},e=t.prototype;function c(t,e){return t._priority-e._priority}e.on=function(t,e,i){if("string"!=typeof t)for(var n in t)this.on(n,t[n],i);else for(var s,r=t.split(" "),o=0,h=r.length;o<h;o++)t=r[o],(s=this._listeners[t])||(s=this._listeners[t]=[]),e._priority=parseInt(i)||0,-1===s.indexOf(e)&&(s.push(e),1<s.length&&s.sort(c));return this},e.off=function(t,e){if(void 0===t||!this._listeners)return this._listeners={},this;if(void 0===this._listeners[t])return this;if(void 0===e)delete this._listeners[t];else for(var i=this._listeners[t],n=0,s=i.length;n<s;n++)if(i[n]===e){i.splice(n,1);break}return this},e.trigger=function(t){"string"==typeof t&&(t={type:t});var e=this._listeners[t.type];if(void 0!==e)for(var i=e.length-1;0<=i;i--)e[i](t)},e.destroy=function(){this._listeners=null},"undefined"!=typeof window&&(window.BellhopEventDispatcher=t),"undefined"!=typeof module&&(module.exports=t)}(),function(){var t;"undefined"!=typeof window?t=window.BellhopEventDispatcher:"function"==typeof require&&(t=require("./BellhopEventDispatcher.js"));var r=function(){t.call(this),this.onReceive=this.receive.bind(this),this.connected=!1,this.name="",this.isChild=!0,this.connecting=!1,this.origin="*",this._sendLater=[],this.supported=null,this.iframe=null},e=t.prototype,i=r.prototype=Object.create(e);i.receive=function(t){if(t.source===this.target){var e=t.data;if("connected"===e){this.connecting=!1,this.connected=!0,this.trigger("connected"),this.isChild||this.target.postMessage(e,this.origin);var i,n=this._sendLater.length;if(0<n){for(i=0;i<n;i++){var s=this._sendLater[i];this.send(s.type,s.data)}this._sendLater.length=0}}else{if(!this.connected)return;try{e=JSON.parse(e,r.reviver)}catch(t){return}"object"==typeof e&&e.type&&this.trigger(e)}}},i.toString=function(){return"[Bellhop '"+this.name+"']"},Object.defineProperty(i,"target",{get:function(){return this.isChild?window.parent:this.iframe.contentWindow}}),i.connect=function(t,e){if(this.connecting)return this;this.disconnect(),this.connecting=!0,this._sendLater||(this._sendLater=[]),this.iframe=t||null;var i=this.isChild=void 0===t,n=this.target;return this.supported=i?!!n&&window!=n:!!n,this.origin=void 0===e?"*":e,window.attachEvent?window.attachEvent("onmessage",this.onReceive):window.addEventListener("message",this.onReceive),i&&(window===n?this.trigger("failed"):"complete"===window.document.readyState?n.postMessage("connected",this.origin):window.onload=function(){n.postMessage("connected",this.origin)}.bind(this)),this},i.disconnect=function(){return this.connected=!1,this.connecting=!1,this.origin=null,this.iframe=null,this._sendLater&&(this._sendLater.length=0),this.isChild=!0,window.detachEvent?window.detachEvent("onmessage",this.onReceive):window.removeEventListener("message",this.onReceive),this},i.send=function(t,e){if("string"!=typeof t)throw"The event type must be a string";if(t={type:t},void 0!==e&&(t.data=e),this.connecting)this._sendLater.push(t);else{if(!this.connected)return this;this.target.postMessage(JSON.stringify(t),this.origin)}return this},i.fetch=function(t,e,i,n){var s=this;if(!this.connecting&&!this.connected)throw"No connection, please call connect() first";n=void 0!==n&&n;var r=function(t){n&&s.off(t.type,r),e(t)};return this.on(t,r),this.send(t,i),this},i.respond=function(e,i,n){n=void 0!==n&&n;var s=this,r=function(t){n&&s.off(t.type,r),s.send(e,"function"==typeof i?i():i)};return this.on(e,r),this},i.destroy=function(){e.destroy.call(this),this.disconnect(),this._sendLater=null},r.reviver=function(t,e){if(e&&"string"==typeof e.__classname){var i=s(e.__classname);if(i){var n=new i;if(n.fromJSON)return n.fromJSON(e),n}}return e};var s=function(t){for(var e=t.split("."),i=window;e.length;)if(!(i=i[e.shift()]))return;return i};"undefined"!=typeof window&&(window.Bellhop=r),"undefined"!=typeof module&&(module.exports=r)}();